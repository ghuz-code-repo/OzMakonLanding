# Система приоритетной загрузки медиафайлов

## Описание

Эта система обеспечивает быструю загрузку страницы для пользователя путем приоритетной загрузки критических медиафайлов и последующей фоновой загрузки остального контента.

## Архитектура

### Компоненты

1. **MediaPreloader** - Основной провайдер контекста для управления состоянием загрузки медиафайлов
2. **MediaInitializer** - Компонент инициализации, который управляет порядком загрузки
3. **CachedImage** - Компонент для отображения кешированных изображений
4. **CachedBackgroundImage** - Компонент для кешированных фоновых изображений
5. **LoadingProgressAdvanced** - Улучшенный компонент отображения прогресса загрузки

### Хуки

1. **useCachedImage** - Хук для работы с кешированными изображениями
2. **useMediaLoadingStats** - Хук для получения статистики загрузки

### Утилиты

1. **mediaConfigGenerator** - Генератор конфигурации медиафайлов

## Принцип работы

### 1. Приоритетная загрузка

Критические медиафайлы загружаются в первую очередь:
- Фон Hero блока
- Все изображения блока Conception
- Первые 2 изображения из первого слайда карусели

### 2. Показ страницы

После загрузки критических медиафайлов страница становится видимой для пользователя.

### 3. Фоновая загрузка

Остальные медиафайлы загружаются в фоне с интервалами:
- Карусель (остальные слайды) - через 100мс
- Планировки квартир - через 500мс  
- Места вокруг - через 1000мс
- Локация - через 1500мс

### 4. Кеширование

Все загруженные изображения сохраняются в браузерном кеше и повторно используются без новых запросов.

## Использование

### Базовое использование

```jsx
import { MediaPreloaderProvider } from './components/MediaPreloader/MediaPreloader';
import MediaInitializer from './components/MediaPreloader/MediaInitializer';
import LoadingProgressAdvanced from './components/MediaPreloader/LoadingProgressAdvanced';

function App() {
  return (
    <MediaPreloaderProvider>
      <MediaInitializer>
        <LoadingProgressAdvanced />
        {/* Ваш контент */}
      </MediaInitializer>
    </MediaPreloaderProvider>
  );
}
```

### Использование кешированных изображений

```jsx
import CachedImage from './components/CachedImage/CachedImage';
import CachedBackgroundImage from './components/CachedImage/CachedBackgroundImage';

// Обычное изображение
<CachedImage 
  src="/path/to/image.webp" 
  alt="Description" 
  className="image-class"
/>

// Фоновое изображение
<CachedBackgroundImage 
  src="/path/to/background.webp" 
  className="background-class"
>
  {/* Контент поверх фона */}
</CachedBackgroundImage>
```

### Использование хуков

```jsx
import { useCachedImage, useMediaLoadingStats } from './hooks/useCachedImage';

function MyComponent() {
  const { isImageCached, imageSrc } = useCachedImage('/path/to/image.webp');
  const { overallProgress, allGroupsCompleted } = useMediaLoadingStats();
  
  return (
    <div>
      <p>Изображение загружено: {isImageCached ? 'Да' : 'Нет'}</p>
      <p>Общий прогресс: {overallProgress}%</p>
      <p>Все группы завершены: {allGroupsCompleted ? 'Да' : 'Нет'}</p>
    </div>
  );
}
```

## Конфигурация

Конфигурация медиафайлов находится в `src/utils/mediaConfigGenerator.js`. Файл автоматически генерирует списки изображений по группам:

- **critical** - Критические изображения для первоначальной загрузки
- **carousel** - Изображения карусели (загружаются в фоне)
- **apartments** - Изображения планировок
- **places** - Изображения мест вокруг
- **location** - Изображения локации

## Особенности

### Обработка ошибок

- Если критические медиафайлы не загружаются, страница все равно показывается пользователю
- Ошибки загрузки отображаются в компоненте прогресса
- Есть fallback изображения для случаев ошибок

### Оптимизация производительности

- Использование браузерного кеша для избежания повторных запросов
- Постепенная загрузка с интервалами для снижения нагрузки
- Shimmer эффекты во время загрузки изображений

### Пользовательский интерфейс

- Красивый экран загрузки для критических медиафайлов
- Интерактивный индикатор прогресса с возможностью сворачивания
- Детальная статистика по группам медиафайлов

## Мониторинг

Компонент `LoadingProgressAdvanced` предоставляет детальную информацию о процессе загрузки:

- Общий прогресс загрузки всех медиафайлов
- Прогресс по каждой группе отдельно
- Количество загруженных/общих файлов
- Информацию об ошибках загрузки
- Возможность сворачивания и скрытия индикатора

## Преимущества

1. **Быстрый FCP (First Contentful Paint)** - пользователь видит контент максимально быстро
2. **Отсутствие дерганий** - все изображения предзагружены и кешированы
3. **Хороший UX** - красивые placeholder'ы и индикаторы загрузки
4. **Эффективное использование ресурсов** - постепенная загрузка не перегружает сеть
5. **Масштабируемость** - легко добавлять новые группы медиафайлов

## Будущие улучшения

- Автоматическое определение критических изображений на основе viewport
- Поддержка разных форматов изображений (WebP, AVIF)
- Интеграция с Service Worker для офлайн кеширования
- Аналитика производительности загрузки
